# Offline Features Implementation

## Overview
The Tree Survey Application now includes IndexedDB-based offline support with a visual offline indicator. Users can continue working when connection is lost, and changes will be automatically synced when connection is restored.

## Features Implemented

### 1. IndexedDB Storage (`offline-db.js`)
A complete offline database module with the following capabilities:

**Object Stores:**
- `pendingOperations`: Queue for operations that failed or were attempted while offline
- `offlineCache`: Local cache for data to enable offline viewing

**Key Functions:**
- `addPendingOperation(operation)`: Queue an operation for later sync
- `getPendingOperations()`: Retrieve all pending operations
- `removePendingOperation(id)`: Remove operation after successful sync
- `getPendingCount()`: Get count of pending operations
- `cacheData(key, data)`: Cache data locally
- `getCachedData(key)`: Retrieve cached data

### 2. Offline Indicator (Visual Feedback)
**Location:** Top-right corner of the header, next to mode selector

**Components:**
- Red pulsing dot when offline
- "Offline" text label
- Pending operations counter (e.g., "3 pending")

**Behavior:**
- Hidden when online
- Appears automatically when connection is lost
- Shows count of queued operations
- Updates every 5 seconds

### 3. Network Monitoring (`app.js`)
**Features:**
- Detects online/offline status using `navigator.onLine`
- Listens for `online` and `offline` browser events
- Updates UI in real-time
- Triggers automatic sync when connection restored

### 4. Offline Queue Integration
All save operations now support offline queueing:

**Integrated Functions:**
- `handleProjectSubmit()` - Projects
- `handleSectionSubmit()` - Sections
- `handleGroupSubmit()` - Groups
- `handleTreeSubmit()` - Trees

**Behavior:**
1. **When Offline:** Operation is queued in IndexedDB, user sees alert
2. **When Connection Lost Mid-Save:** Catches error, queues operation automatically
3. **When Back Online:** All queued operations sync automatically in order

### 5. Auto-Sync on Reconnect
When connection is restored:
1. System detects `online` event
2. Fetches all pending operations from IndexedDB
3. Executes each operation in order
4. Removes successfully synced operations
5. Keeps failed operations for retry
6. Updates pending count display

## User Experience Flow

### Scenario 1: Going Offline
1. User is working online
2. Connection lost (airplane mode, no signal, etc.)
3. **Offline indicator appears** with red pulsing dot
4. User tries to save a tree
5. Alert: "You are offline. Tree will be saved when connection is restored."
6. Operation queued in IndexedDB
7. **Pending count updates**: "1 pending"

### Scenario 2: Multiple Offline Changes
1. User creates 3 trees while offline
2. Pending count shows: "3 pending"
3. Each operation queued in order
4. User can continue viewing previously loaded data

### Scenario 3: Connection Restored
1. Device reconnects to network
2. **Offline indicator disappears**
3. Auto-sync begins automatically
4. Operations synced in order: Tree 1 → Tree 2 → Tree 3
5. Pending count decreases: "2 pending" → "1 pending" → hidden
6. User can continue working normally

### Scenario 4: Connection Lost During Save
1. User clicks "Save Group"
2. Request starts but connection drops mid-request
3. Fetch throws error
4. System detects offline status
5. Automatically queues the operation
6. Alert: "Connection lost. Group will be saved when connection is restored."

## Technical Details

### Data Structure for Queued Operations
```javascript
{
  id: 1,  // Auto-generated by IndexedDB
  type: 'create',  // or 'update', 'delete'
  entity: 'tree',  // 'project', 'section', 'group', 'tree'
  data: { /* the object to save */ },
  method: 'POST',  // or 'PUT', 'DELETE'
  url: '/api/trees',
  timestamp: 1704312000000,
  status: 'pending'
}
```

### Sync Logic
```javascript
async function syncPendingOperations() {
  if (!isOnline) return;

  const pending = await offlineDB.getPendingOperations();

  for (const operation of pending) {
    try {
      await executeOperation(operation);
      await offlineDB.removePendingOperation(operation.id);
    } catch (error) {
      // Keep in queue for next sync attempt
    }
  }
}
```

### Network Detection
- **Primary:** `navigator.onLine` property
- **Event Listeners:** `window.addEventListener('online')` and `window.addEventListener('offline')`
- **Fallback:** Catch network errors during fetch operations
- **Polling:** Pending count updates every 5 seconds

## CSS Styling

### Offline Indicator
```css
.offline-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  font-size: 14px;
  color: #ffffff;
}

.offline-indicator .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #ff6b6b;
  animation: pulse 2s infinite;
}
```

## Files Modified

1. **`public/offline-db.js`** (NEW)
   - Complete IndexedDB wrapper
   - 190+ lines of offline storage logic

2. **`public/index.html`**
   - Added offline indicator HTML
   - Added script tag for offline-db.js

3. **`public/app.js`**
   - Added `isOnline` state variable
   - Added `initializeOfflineSupport()` function
   - Modified all save functions (Projects, Sections, Groups, Trees)
   - Added offline detection and auto-sync

4. **`public/styles.css`**
   - Added `.offline-indicator` styles
   - Added pulsing animation for status dot
   - Added pending count badge styles

## Testing

### Manual Testing Steps
1. **Test Offline Indicator:**
   - Open app in browser
   - Open DevTools → Network tab
   - Set to "Offline" mode
   - Verify indicator appears

2. **Test Offline Save:**
   - Go offline in DevTools
   - Try to create a new tree
   - Check alert message
   - Verify operation queued (check IndexedDB in DevTools → Application → IndexedDB)

3. **Test Auto-Sync:**
   - Create 2-3 items while offline
   - Check pending count increases
   - Go back online
   - Watch pending count decrease to 0
   - Verify items saved in database

4. **Test Connection Loss During Save:**
   - Start online
   - Begin save operation
   - Quickly go offline before response
   - Verify operation queued automatically

### Test Page
A dedicated test page is available at `/test-offline.html` with:
- Real-time online/offline status
- Test buttons for IndexedDB operations
- Log viewer for debugging
- Pending operations viewer

## Limitations

### Current Implementation
✅ **Working:**
- Visual offline indicator
- Operation queueing when offline
- Auto-sync when reconnected
- Pending operations counter
- All CRUD operations supported

❌ **Not Implemented (from original plan):**
- Background sync using Service Worker
- Conflict resolution for concurrent edits
- Offline-first optimistic updates with local IDs
- IndexedDB caching of all data for full offline viewing

### Known Edge Cases
1. **Auto-generated IDs:** If user creates multiple items offline, they won't have IDs until synced. The current implementation doesn't handle optimistic local IDs.

2. **Order Dependencies:** If user creates Project → Section → Group offline, they must sync in order. Current implementation syncs in queue order.

3. **Edit Conflicts:** If same item edited offline on multiple devices, last sync wins (no conflict resolution).

4. **Large Queues:** If hundreds of operations queued, sync might take time. No progress indicator implemented.

## Future Enhancements

### Priority 1: Background Sync
Implement Service Worker background sync API to sync even when tab is closed.

### Priority 2: Conflict Resolution
Add timestamp-based or user-prompted conflict resolution for concurrent edits.

### Priority 3: Full Offline Mode
Cache all projects/sections/groups in IndexedDB for complete offline viewing.

### Priority 4: Optimistic Updates with Temporary IDs
Generate temporary IDs locally, update optimistically, replace with server IDs on sync.

## Browser Compatibility

**IndexedDB:** Supported in all modern browsers
- Chrome 24+
- Firefox 16+
- Safari 10+
- Edge 12+

**Online/Offline Events:** Supported in all modern browsers
- May not detect all network issues (e.g., connected but no internet)

## Debugging

### View Pending Operations
1. Open DevTools (F12)
2. Go to Application tab
3. Expand IndexedDB
4. Find "TreeSurveyOfflineDB"
5. Click "pendingOperations"
6. View all queued operations

### Console Logs
- Operation queued: "Added pending operation"
- Sync started: "Syncing pending operations"
- Sync success: "Synced operation: {operation}"
- Sync failed: "Failed to sync operation: {operation}"

## Summary

The offline features provide a robust safety net for field workers who may lose connectivity. Users can continue logging trees, and all changes will automatically sync when connection is restored. The visual indicator provides clear feedback about connection status and pending operations.

**Offline Capability Rating: 8/10**
- Excellent offline save queuing
- Good visual feedback
- Automatic sync on reconnect
- Missing full offline viewing and conflict resolution
